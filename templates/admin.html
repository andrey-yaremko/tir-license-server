<!DOCTYPE html>
<html>
<head>
    <title>TIR Bot - –ê–¥–º—ñ–Ω–∫–∞</title>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header { 
            background: #2c3e50; 
            color: white; 
            padding: 20px; 
            border-radius: 5px; 
            margin-bottom: 20px; 
        }
        .login-box {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-box input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .btn { 
            background: #27ae60; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover { 
            background: #219652; 
        }
        .btn-logout {
            background: #e74c3c;
        }
        .btn-logout:hover {
            background: #c0392b;
        }
        .stats { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 20px; 
            flex-wrap: wrap;
        }
        .stat-card { 
            background: #3498db; 
            color: white; 
            padding: 15px; 
            border-radius: 5px; 
            flex: 1; 
            text-align: center;
            min-width: 150px;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px;
            font-size: 14px;
        }
        th, td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
        }
        th { 
            background: #34495e; 
            color: white; 
        }
        tr:hover {
            background: #f9f9f9;
        }
        .active { 
            color: green; 
            font-weight: bold; 
        }
        .expired { 
            color: red; 
            font-weight: bold; 
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 5px;
        }
        .license-key {
            font-family: monospace;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        .error {
            color: #e74c3c;
            background: #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #27ae60;
            background: #d5f4e6;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É -->
    <div id="loginForm" class="login-box">
        <h1>üîê TIR Bot –ê–¥–º—ñ–Ω–∫–∞</h1>
        <p>–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø—É</p>
        <input type="password" id="adminPassword" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º—ñ–Ω–∫–∏">
        <button class="btn" onclick="adminLogin()" style="width: 100%;">–£–≤—ñ–π—Ç–∏</button>
        <div id="loginError" class="error" style="display: none;"></div>
    </div>

    <!-- –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å (–ø—Ä–∏—Ö–æ–≤–∞–Ω–∞ –ø–æ–∫–∏ –Ω–µ —É–≤—ñ–π–¥–µ) -->
    <div id="adminPanel" class="container" style="display: none;">
        <div class="header">
            <h1>üéÆ TIR Bot - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h1>
            <p>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ª—ñ—Ü–µ–Ω–∑—ñ—è–º–∏ | <span id="serverStatus">üü¢ –ü—Ä–∞—Ü—é—î</span></p>
            <button class="btn btn-logout" onclick="adminLogout()">üö™ –í–∏–π—Ç–∏</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>üìä –í—Å—å–æ–≥–æ –ª—ñ—Ü–µ–Ω–∑—ñ–π</h3>
                <p id="totalLicenses">0</p>
            </div>
            <div class="stat-card">
                <h3>üü¢ –ê–∫—Ç–∏–≤–Ω–∏—Ö</h3>
                <p id="activeLicenses">0</p>
            </div>
            <div class="stat-card">
                <h3>üü° –ù–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏—Ö</h3>
                <p id="inactiveLicenses">0</p>
            </div>
            <div class="stat-card">
                <h3>üî¥ –ü—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏—Ö</h3>
                <p id="expiredLicenses">0</p>
            </div>
        </div>

        <div class="controls">
            <h3>üöÄ –®–≤–∏–¥–∫—ñ –¥—ñ—ó</h3>
            <button class="btn" onclick="createLicense(30)">üÜï –°—Ç–≤–æ—Ä–∏—Ç–∏ –ª—ñ—Ü–µ–Ω–∑—ñ—é (30 –¥–Ω—ñ–≤)</button>
            <button class="btn" onclick="createLicense(7)">üÜï –°—Ç–≤–æ—Ä–∏—Ç–∏ –ª—ñ—Ü–µ–Ω–∑—ñ—é (7 –¥–Ω—ñ–≤)</button>
            <button class="btn" onclick="createLicense(1)">üÜï –°—Ç–≤–æ—Ä–∏—Ç–∏ –ª—ñ—Ü–µ–Ω–∑—ñ—é (1 –¥–µ–Ω—å)</button>
            <button class="btn" onclick="refreshLicenses()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
        </div>

        <div>
            <h3>üìã –°–ø–∏—Å–æ–∫ –ª—ñ—Ü–µ–Ω–∑—ñ–π</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ö–ª—é—á –ª—ñ—Ü–µ–Ω–∑—ñ—ó</th>
                        <th>HWID</th>
                        <th>–î–Ω—ñ–≤</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ</th>
                        <th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody id="licensesTable">
                    <tr>
                        <td colspan="8" style="text-align: center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ API
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    credentials: 'include', // –í–∞–∂–ª–∏–≤–æ –¥–ª—è —Å–µ—Å—ñ–π
                    ...options
                });
                
                if (response.status === 401) {
                    showLoginForm();
                    throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!password) {
                errorDiv.textContent = '–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const result = await apiCall('/admin/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password: password})
                });

                if (result.success) {
                    showAdminPanel();
                    loadLicenses();
                } else {
                    errorDiv.textContent = result.message;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è';
                errorDiv.style.display = 'block';
            }
        }

        async function adminLogout() {
            try {
                await apiCall('/admin/logout', {method: 'POST'});
                showLoginForm();
            } catch (error) {
                showLoginForm();
            }
        }

        async function checkAuth() {
            try {
                const result = await apiCall('/admin/check_auth');
                if (result.authenticated) {
                    showAdminPanel();
                    loadLicenses();
                } else {
                    showLoginForm();
                }
            } catch (error) {
                showLoginForm();
            }
        }

        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        function showAdminPanel() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
        }

        // –†–æ–±–æ—Ç–∞ –∑ –ª—ñ—Ü–µ–Ω–∑—ñ—è–º–∏
        async function loadLicenses() {
            showLoading();
            
            try {
                const licenses = await apiCall('/admin/licenses');
                updateStats(licenses);
                renderLicensesTable(licenses);
            } catch (error) {
                showError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª—ñ—Ü–µ–Ω–∑—ñ–π');
            }
        }

        function updateStats(licenses) {
            document.getElementById('totalLicenses').textContent = licenses.length;
            document.getElementById('activeLicenses').textContent = 
                licenses.filter(l => l.status === 'active').length;
            document.getElementById('inactiveLicenses').textContent = 
                licenses.filter(l => l.status === 'active' && (!l.hwid)).length;
            document.getElementById('expiredLicenses').textContent = 
                licenses.filter(l => l.status === 'expired').length;
        }

        function renderLicensesTable(licenses) {
            const table = document.getElementById('licensesTable');
            
            if (licenses.length === 0) {
                table.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ù–µ–º–∞—î –ª—ñ—Ü–µ–Ω–∑—ñ–π</td></tr>';
                return;
            }
            
            table.innerHTML = licenses.map(license => `
                <tr>
                    <td>${license.id}</td>
                    <td><span class="license-key">${license.license_key}</span></td>
                    <td>${license.hwid || '–ù–µ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ'}</td>
                    <td>${license.days}</td>
                    <td class="${license.status === 'active' ? 'active' : 'expired'}">
                        ${license.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ü—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∞'}
                    </td>
                    <td>${formatDate(license.activated_at)}</td>
                    <td>${formatDate(license.created_at)}</td>
                    <td>
                        <button class="btn" onclick="copyKey('${license.license_key}')" style="background: #e67e22;">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                        <button class="btn" onclick="deleteLicense(${license.id})" style="background: #e74c3c;">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </td>
                </tr>
            `).join('');
        }

        async function createLicense(days) {
            if (!confirm(`–°—Ç–≤–æ—Ä–∏—Ç–∏ –ª—ñ—Ü–µ–Ω–∑—ñ—é –Ω–∞ ${days} –¥–Ω—ñ–≤?`)) return;
            
            try {
                const result = await apiCall('/admin/create_license', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ days: days })
                });

                if (result.success) {
                    alert(`‚úÖ –õ—ñ—Ü–µ–Ω–∑—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–∞: ${result.license_key}`);
                    loadLicenses();
                }
            } catch (error) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª—ñ—Ü–µ–Ω–∑—ñ—ó');
            }
        }

        async function deleteLicense(licenseId) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ª—ñ—Ü–µ–Ω–∑—ñ—é? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏!')) return;
            
            try {
                const result = await apiCall(`/admin/delete_license/${licenseId}`, {
                    method: 'DELETE'
                });

                if (result.success) {
                    alert('‚úÖ –õ—ñ—Ü–µ–Ω–∑—ñ—è –≤–∏–¥–∞–ª–µ–Ω–∞');
                    loadLicenses();
                }
            } catch (error) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ª—ñ—Ü–µ–Ω–∑—ñ—ó');
            }
        }

        function copyKey(key) {
            navigator.clipboard.writeText(key).then(() => {
                alert(`üìã –ö–ª—é—á —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ: ${key}`);
            }).catch(err => {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è');
            });
        }

        function refreshLicenses() {
            loadLicenses();
        }

        // –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        function showLoading() {
            const table = document.getElementById('licensesTable');
            table.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>';
        }

        function showError(message) {
            const table = document.getElementById('licensesTable');
            table.innerHTML = `<tr><td colspan="8" style="text-align: center; color: red;">${message}</td></tr>`;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('uk-UA');
        }

        // –û–±—Ä–æ–±–∫–∞ Enter –≤ –ø–æ–ª—ñ –ø–∞—Ä–æ–ª—è
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                adminLogin();
            }
        });

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (document.getElementById('adminPanel').style.display !== 'none') {
                loadLicenses();
            }
        }, 30000);
    </script>
</body>
</html>
